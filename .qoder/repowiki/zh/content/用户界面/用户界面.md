# 用户界面

<cite>
**本文档中引用的文件**  
- [SidePanel.tsx](file://pages/side-panel/src/SidePanel.tsx)
- [ChatInput.tsx](file://pages/side-panel/src/components/ChatInput.tsx)
- [MessageList.tsx](file://pages/side-panel/src/components/MessageList.tsx)
- [ChatHistoryList.tsx](file://pages/side-panel/src/components/ChatHistoryList.tsx)
- [BookmarkList.tsx](file://pages/side-panel/src/components/BookmarkList.tsx)
- [Options.tsx](file://pages/options/src/Options.tsx)
- [ModelSettings.tsx](file://pages/options/src/components/ModelSettings.tsx)
- [GeneralSettings.tsx](file://pages/options/src/components/GeneralSettings.tsx)
- [FirewallSettings.tsx](file://pages/options/src/components/FirewallSettings.tsx)
- [AnalyticsSettings.tsx](file://pages/options/src/components/AnalyticsSettings.tsx)
- [permission.js](file://chrome-extension/public/permission/permission.js)
- [message.ts](file://pages/side-panel/src/types/message.ts)
- [event.ts](file://pages/side-panel/src/types/event.ts)
</cite>

## 目录
1. [简介](#简介)
2. [侧边栏界面](#侧边栏界面)
3. [选项页面](#选项页面)
4. [权限页面](#权限页面)
5. [UI状态管理](#ui状态管理)

## 简介
nanobrowser的用户界面由三个主要部分组成：侧边栏（Side Panel）、选项页面（Options）和权限页面（Permission）。侧边栏是用户与AI代理进行交互的主要界面，提供聊天输入、消息列表和任务状态显示功能。选项页面允许用户配置LLM提供商、分析设置和防火墙规则。权限页面处理用户授权流程，特别是麦克风权限的获取。本文档详细记录了这些UI组件的功能、交互方式和状态管理机制。

## 侧边栏界面

侧边栏是nanobrowser的核心交互界面，为用户提供与AI代理进行对话的主要通道。它包含聊天输入框、消息列表、历史记录和书签等功能，支持用户发起新任务、查看对话历史和管理常用提示。

### 聊天输入组件
聊天输入组件（ChatInput）是用户与AI代理交互的主要入口。它提供了一个文本区域供用户输入任务指令，并支持文件附件功能。用户可以通过点击麦克风图标启用语音输入，系统会将语音转换为文本并发送给AI代理。

输入组件包含以下功能：
- **文本输入**：支持多行文本输入，自动调整高度
- **文件附件**：允许用户附加文本文件（如.txt、.md、.json等），文件内容会被标记并包含在消息中
- **语音输入**：通过麦克风图标启动语音识别，将语音转换为文本
- **发送/停止按钮**：根据任务状态显示发送新消息或停止当前任务的按钮
- **重放功能**：在历史会话中显示重放按钮，允许用户重新执行之前的任务

当用户提交消息时，系统会检查是否为命令（以"/"开头），如"/replay"用于重放历史任务，"/state"用于获取当前状态等。

**组件来源**
- [ChatInput.tsx](file://pages/side-panel/src/components/ChatInput.tsx)

### 消息列表组件
消息列表组件（MessageList）显示用户与AI代理之间的完整对话历史。每条消息都带有发送者头像、名称和时间戳，不同发送者使用不同的颜色标识。

消息类型包括：
- **用户**：用户输入的消息，绿色标识
- **系统**：系统通知和状态信息，蓝色标识
- **规划器（Planner）**：任务规划信息，橙色标识
- **导航器（Navigator）**：页面导航和操作信息，天蓝色标识
- **验证器（Validator）**：任务验证信息，粉色标识

系统消息中的"显示进度..."会显示为进度条动画，直观地表示任务正在执行中。时间戳会根据消息时间显示为"今天"、"昨天"或具体日期。

**组件来源**
- [MessageList.tsx](file://pages/side-panel/src/components/MessageList.tsx)
- [message.ts](file://pages/side-panel/src/types/message.ts)

### 任务状态显示
侧边栏通过实时事件系统显示任务执行状态。系统定义了多种执行状态，包括任务开始、步骤开始、操作开始等，这些状态变化会实时反映在消息列表中。

关键状态包括：
- **任务级别**：开始、成功、失败、取消
- **步骤级别**：开始、成功、失败
- **操作级别**：开始、成功、失败

当任务执行时，系统会显示"显示进度..."消息和进度条，让用户了解AI代理正在工作。任务完成后，会显示相应的成功或失败消息。

**组件来源**
- [SidePanel.tsx](file://pages/side-panel/src/SidePanel.tsx)
- [event.ts](file://pages/side-panel/src/types/event.ts)

### 历史记录和书签
侧边栏提供聊天历史记录和书签功能，帮助用户管理过去的对话和常用提示。

**聊天历史记录**：
- 显示所有会话的标题和创建时间
- 支持点击会话查看完整对话历史
- 提供删除会话功能
- 支持将会话添加到书签

**书签功能**：
- 显示用户收藏的常用提示
- 支持拖拽重新排序
- 支持编辑书签标题
- 支持删除书签
- 点击书签可将其内容填充到聊天输入框

这些功能通过ChatHistoryList和BookmarkList组件实现，提供直观的用户界面和交互体验。

**组件来源**
- [ChatHistoryList.tsx](file://pages/side-panel/src/components/ChatHistoryList.tsx)
- [BookmarkList.tsx](file://pages/side-panel/src/components/BookmarkList.tsx)

## 选项页面

选项页面（Options）是用户配置nanobrowser各项设置的中心界面。它采用标签式布局，将不同类型的设置分组管理，包括通用设置、模型设置、防火墙设置和分析设置。

### LLM提供商配置
在模型设置标签页中，用户可以配置不同的LLM提供商，包括OpenAI、Anthropic、Groq等。每个提供商需要提供API密钥，并可以自定义名称。

配置选项包括：
- **API密钥**：用于验证用户身份
- **自定义名称**：为提供商设置易于识别的名称
- **基础URL**：对于自定义OpenAI兼容API，可以指定不同的端点
- **模型管理**：添加或删除特定模型

系统支持多种提供商类型，包括Azure OpenAI，对于Azure用户还需要配置部署名称和API版本。

**组件来源**
- [ModelSettings.tsx](file://pages/options/src/components/ModelSettings.tsx)

### 分析设置
分析设置允许用户控制是否共享匿名使用数据来帮助改进nanobrowser。这是一个可选功能，用户可以随时启用或禁用。

收集的数据包括：
- 任务执行指标（开始、完成、失败次数和持续时间）
- 访问网站的域名（如"amazon.com"，不包括完整URL）
- 任务失败的错误类别（不含敏感细节）
- 匿名使用统计

系统明确说明不会收集以下数据：
- 个人信息或登录凭证
- 完整URL或页面内容
- 任务指令或用户提示
- 屏幕录制或截图
- 任何敏感或私人数据

**组件来源**
- [AnalyticsSettings.tsx](file://pages/options/src/components/AnalyticsSettings.tsx)

### 防火墙规则
防火墙设置允许用户配置网站访问规则，控制AI代理可以访问的网站范围。用户可以设置允许列表（白名单）和拒绝列表（黑名单）。

功能包括：
- **启用/禁用防火墙**：全局开关
- **允许列表**：指定AI代理可以访问的网站
- **拒绝列表**：指定AI代理不能访问的网站
- **域名输入**：支持输入域名（自动去除http://或https://前缀）

防火墙的工作原理是：当AI代理尝试访问网站时，系统会检查目标域名是否在允许列表中（如果允许列表不为空），或者是否不在拒绝列表中。只有通过检查的请求才会被执行。

**组件来源**
- [FirewallSettings.tsx](file://pages/options/src/components/FirewallSettings.tsx)

### 通用设置
通用设置包含影响AI代理行为的各种参数，用户可以根据需要调整。

可配置的选项包括：
- **最大步骤数**：限制单个任务的最大执行步骤
- **每步最大操作数**：限制每个步骤中可以执行的操作数量
- **最大失败次数**：设置任务在失败前可以重试的次数
- **启用视觉功能**：允许AI代理使用视觉能力分析页面内容
- **显示高亮**：在页面上显示AI代理操作的高亮指示
- **规划间隔**：设置AI代理规划步骤的时间间隔
- **页面加载最小等待时间**：确保页面完全加载的最短等待时间
- **重放历史任务**：允许用户重放之前执行过的任务

这些设置直接影响AI代理的性能和行为，用户可以根据具体需求进行调整。

**组件来源**
- [GeneralSettings.tsx](file://pages/options/src/components/GeneralSettings.tsx)

## 权限页面

权限页面负责处理用户授权流程，特别是麦克风权限的获取。当用户首次尝试使用语音输入功能时，系统会打开权限页面请求必要的权限。

### 用户授权流程
权限页面的用户授权流程如下：
1. 用户点击侧边栏的麦克风图标
2. 系统检测到尚未获得麦克风权限
3. 打开权限页面请求麦克风访问权限
4. 用户点击"授予麦克风权限"按钮
5. 系统请求navigator.mediaDevices.getUserMedia({ audio: true })
6. 浏览器显示标准权限请求对话框
7. 用户在浏览器对话框中授予权限
8. 系统验证权限已授予并关闭权限页面

如果权限已被授予，页面会显示相应提示并禁用请求按钮。

### 权限处理逻辑
权限页面的JavaScript代码（permission.js）实现了完整的权限处理逻辑：

- **国际化支持**：使用chrome.i18n.getMessage获取本地化文本
- **权限状态检查**：使用navigator.permissions.query检查当前权限状态
- **错误处理**：处理各种可能的错误情况，如用户拒绝、找不到麦克风等
- **用户体验**：提供清晰的状态反馈和操作指引

当权限请求成功后，系统会立即停止媒体流（以保护用户隐私），更新UI显示成功状态，并在2秒后自动关闭页面。

**组件来源**
- [permission.js](file://chrome-extension/public/permission/permission.js)
- [index.html](file://chrome-extension/public/permission/index.html)

## UI状态管理

nanobrowser的UI状态管理采用React的useState和useCallback钩子，结合Chrome扩展的存储机制，实现了高效的状态管理和数据持久化。

### 状态管理机制
系统使用多种状态管理技术：
- **React状态**：使用useState管理组件本地状态
- **回调函数**：使用useCallback确保函数引用的稳定性
- **引用对象**：使用useRef存储不需要触发重新渲染的数据
- **效果钩子**：使用useEffect处理副作用和生命周期事件

关键状态包括：
- **消息列表**：存储当前会话的所有消息
- **输入启用状态**：控制聊天输入是否可用
- **停止按钮显示**：根据任务状态显示或隐藏停止按钮
- **会话ID**：跟踪当前任务的唯一标识符
- **历史记录状态**：管理历史会话的显示和选择

### 用户输入传递
用户输入通过以下流程传递给后台脚本：
1. 用户在聊天输入框中输入文本并提交
2. ChatInput组件调用onSendMessage回调
3. SidePanel组件处理消息，创建新的会话（如果需要）
4. 建立与后台服务的连接（如果尚未建立）
5. 使用chrome.runtime.connect创建端口连接
6. 通过postMessage将任务发送到后台服务

系统实现了心跳机制，每25秒发送一次心跳消息以保持连接活跃。如果连接断开或心跳失败，系统会自动清理状态并允许用户重新连接。

### 数据持久化
所有聊天历史和用户设置都通过@extension/storage模块持久化存储：
- **聊天历史**：使用chatHistoryStore保存会话和消息
- **模型配置**：使用agentModelStore保存LLM提供商和模型设置
- **通用设置**：使用generalSettingsStore保存用户偏好
- **防火墙规则**：使用firewallStore保存允许和拒绝列表

这种分层存储架构确保了数据的安全性和可维护性，同时支持跨会话的数据持久化。

**组件来源**
- [SidePanel.tsx](file://pages/side-panel/src/SidePanel.tsx)
- [Options.tsx](file://pages/options/src/Options.tsx)