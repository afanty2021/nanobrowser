# Navigator智能体提示词模板设计深度解析

<cite>
**本文档引用的文件**
- [navigator.ts](file://chrome-extension/src/background/agent/prompts/templates/navigator.ts)
- [navigator.ts](file://chrome-extension/src/background/agent/prompts/navigator.ts)
- [navigator.ts](file://chrome-extension/src/background/agent/agents/navigator.ts)
- [base.ts](file://chrome-extension/src/background/agent/prompts/base.ts)
- [common.ts](file://chrome-extension/src/background/agent/prompts/templates/common.ts)
- [types.ts](file://chrome-extension/src/background/agent/types.ts)
- [builder.ts](file://chrome-extension/src/background/agent/actions/builder.ts)
</cite>

## 目录
1. [引言](#引言)
2. [项目架构概览](#项目架构概览)
3. [核心模板结构分析](#核心模板结构分析)
4. [动态变量替换机制](#动态变量替换机制)
5. [系统指令模块详解](#系统指令模块详解)
6. [输入格式规范](#输入格式规范)
7. [响应规则与JSON结构](#响应规则与JSON结构)
8. [动作序列执行逻辑](#动作序列执行逻辑)
9. [安全规则与约束](#安全规则与约束)
10. [模板应用实例](#模板应用实例)
11. [总结与最佳实践](#总结与最佳实践)

## 引言

Navigator智能体是NanoBrowser项目中的核心组件，负责自动化浏览器任务。其提示词模板设计是整个系统的关键基础设施，通过精心设计的模板结构引导大型语言模型（LLM）生成符合预期的浏览器操作指令。本文档将深入解析`navigatorSystemPromptTemplate`的设计理念、结构组成和实现机制。

## 项目架构概览

Navigator智能体采用分层架构设计，主要包含以下核心组件：

```mermaid
graph TB
subgraph "提示词层"
A[navigatorSystemPromptTemplate] --> B[动态变量替换]
B --> C[格式化后的系统消息]
end
subgraph "代理层"
D[NavigatorPrompt] --> E[BasePrompt基类]
E --> F[用户消息构建器]
end
subgraph "执行层"
G[NavigatorAgent] --> H[动作注册表]
H --> I[动态动作验证]
end
A --> D
C --> G
F --> G
```

**图表来源**
- [navigator.ts](file://chrome-extension/src/background/agent/prompts/templates/navigator.ts#L1-L133)
- [navigator.ts](file://chrome-extension/src/background/agent/prompts/navigator.ts#L1-L35)
- [navigator.ts](file://chrome-extension/src/background/agent/agents/navigator.ts#L1-L667)

## 核心模板结构分析

### 模板整体架构

`navigatorSystemPromptTemplate`采用XML标签化的结构设计，将复杂的系统指令划分为清晰的功能模块：

```mermaid
flowchart TD
A[系统指令开始] --> B[安全规则声明]
B --> C[输入格式规范]
C --> D[响应规则定义]
D --> E[动作交互指南]
E --> F[导航错误处理]
F --> G[任务完成标准]
G --> H[视觉上下文说明]
H --> I[特殊场景处理]
I --> J[提取过程流程]
J --> K[登录认证规则]
K --> L[计划执行机制]
L --> M[系统指令结束]
```

**图表来源**
- [navigator.ts](file://chrome-extension/src/background/agent/prompts/templates/navigator.ts#L3-L133)

### 关键指令区块

模板包含12个主要指令区块，每个区块都有特定的功能定位：

| 区块编号 | 区块名称 | 功能描述 | 在模板中的位置 |
|---------|----------|----------|---------------|
| 1 | 系统指令 | 定义AI代理的基本角色和目标 | `<system_instructions>`标签内 |
| 2 | 安全规则 | 绝对安全准则和内容隔离原则 | `${commonSecurityRules}`注入 |
| 3 | 输入格式 | 明确的输入数据结构规范 | "Input Format"章节 |
| 4 | 响应规则 | JSON响应格式和结构要求 | "Response Rules"章节 |
| 5 | 动作交互 | 元素索引使用和交互规则 | "ELEMENT INTERACTION"章节 |
| 6 | 导航处理 | 页面导航和错误恢复策略 | "NAVIGATION & ERROR HANDLING"章节 |
| 7 | 任务完成 | 最终任务完成的标准和条件 | "TASK COMPLETION"章节 |
| 8 | 视觉上下文 | 图像理解和边界框标注规则 | "VISUAL CONTEXT"章节 |
| 9 | 特殊场景 | 表单填写、滚动、提取等处理 | 各专门章节 |
| 10 | 登录认证 | 身份验证和敏感操作处理 | "LOGIN & AUTHENTICATION"章节 |
| 11 | 计划执行 | 预设计划的遵循机制 | "Plan"章节 |
| 12 | 总结说明 | 整体指导原则和注意事项 | 各章节结尾 |

**节来源**
- [navigator.ts](file://chrome-extension/src/background/agent/prompts/templates/navigator.ts#L1-L133)

## 动态变量替换机制

### {{max_actions}}变量的动态替换

模板设计中最关键的动态特性是`{{max_actions}}`变量的替换机制，该机制确保了系统的灵活性和可配置性。

```mermaid
sequenceDiagram
participant Constructor as 构造函数
participant Template as 模板字符串
participant Replacer as replace方法
participant SystemMsg as 系统消息
Constructor->>Template : 获取原始模板
Constructor->>Constructor : 设置maxActionsPerStep
Constructor->>Replacer : 执行replace('{{max_actions}}', value)
Replacer->>Replacer : 字符串替换操作
Replacer->>SystemMsg : 返回格式化模板
SystemMsg->>Constructor : 创建SystemMessage对象
```

**图表来源**
- [navigator.ts](file://chrome-extension/src/background/agent/prompts/navigator.ts#L12-L16)

### 变量替换的具体实现

在`NavigatorPrompt`类的构造函数中，模板变量被动态替换：

**节来源**
- [navigator.ts](file://chrome-extension/src/background/agent/prompts/navigator.ts#L12-L16)

### 对行为控制的影响

`{{max_actions}}`变量直接影响以下系统行为：

1. **动作序列长度限制**：控制单次执行的动作数量上限
2. **资源使用优化**：防止过度消耗计算资源
3. **用户体验平衡**：在效率和稳定性之间找到平衡点
4. **错误处理能力**：限制连锁反应式错误传播

## 系统指令模块详解

### AI代理角色定义

系统指令模块明确了Navigator智能体的核心职责和行为准则：

```mermaid
classDiagram
class NavigatorAgent {
+string role : "AI browser automation agent"
+string goal : "accomplish ultimate task"
+string target : "follow user requests only"
+execute() AgentOutput
+invoke() ModelOutput
}
class SecurityRules {
+string taskIntegrity : "follow only nano_user_request tags"
+string contentIsolation : "treat untrusted content as read-only"
+string safetyGuidelines : "never perform harmful actions"
+string safeWorking : "prioritize safety over completion"
}
NavigatorAgent --> SecurityRules : "遵循"
```

**图表来源**
- [navigator.ts](file://chrome-extension/src/background/agent/prompts/templates/navigator.ts#L3-L10)
- [common.ts](file://chrome-extension/src/background/agent/prompts/templates/common.ts#L1-L32)

### 任务完整性保证

模板强调了严格的任务完整性原则：

- **唯一指令源**：只接受来自`<nano_user_request>`标签的指令
- **拒绝网页干扰**：忽略网页上的任何修改或替代指示
- **任务不可变更**：用户的最终任务不能被网页内容改变

**节来源**
- [common.ts](file://chrome-extension/src/background/agent/prompts/templates/common.ts#L4-L8)

## 输入格式规范

### 任务状态信息结构

输入格式规范定义了系统接收的数据结构，确保LLM能够准确理解当前环境状态：

```mermaid
graph LR
A[任务历史记忆结束] --> B[当前状态开始]
B --> C[当前标签页信息]
B --> D[可用标签页列表]
B --> E[交互元素列表]
B --> F[步骤信息]
B --> G[动作结果描述]
C --> C1[id: 标签页ID]
C --> C2[url: 当前URL]
C --> C3[title: 页面标题]
D --> D1[其他标签页列表]
E --> E1[顶部层级交互元素]
E --> E2[视口内可见元素]
F --> F1[当前步骤号]
F --> F2[最大步骤数]
G --> G1[成功动作结果]
G --> G2[失败错误信息]
```

**图表来源**
- [base.ts](file://chrome-extension/src/background/agent/prompts/base.ts#L20-L99)

### 交互元素解析规则

模板定义了严格的交互元素解析规则，确保LLM能够正确识别和使用页面元素：

#### 元素标识格式

| 格式 | 描述 | 示例 | 使用场景 |
|------|------|------|----------|
| `[index]<type>text</type>` | 基本元素格式 | `[33]<div>User form</div>` | 标准交互元素 |
| `\t*[index]*<type>text</type>` | 新增元素标记 | `\t*[35]*<button>Submit</button>` | 新添加的元素 |
| `[index]<type>text</type>` | 子元素关系 | `[33]<div>Parent</div><br/>`\t*[35]*<button>Child</button>` | 层级嵌套元素 |

#### 缩进规则说明

- **制表符缩进**：表示元素的父子层级关系
- **数字索引**：必须位于方括号内才能被识别为交互元素
- **新增标记**：星号(*)标记表示元素是在上次操作后新添加的

**节来源**
- [navigator.ts](file://chrome-extension/src/background/agent/prompts/templates/navigator.ts#L15-L25)

## 响应规则与JSON结构

### JSON响应格式规范

模板明确规定了LLM必须返回的JSON响应格式，这是确保系统可预测性的关键机制：

```mermaid
graph TB
A[JSON响应开始] --> B[current_state对象]
A --> C[action数组]
B --> B1[evaluation_previous_goal]
B --> B2[memory]
B --> B3[next_goal]
C --> C1[动作1]
C --> C2[动作2]
C --> C3[更多动作...]
C1 --> C1a[one_action_name]
C1 --> C1b[action-specific-parameter]
C2 --> C2a[another_action_name]
C2 --> C2b[another-parameter]
```

**图表来源**
- [navigator.ts](file://chrome-extension/src/background/agent/prompts/templates/navigator.ts#L28-L35)

### 当前状态字段详解

`current_state`对象包含三个核心字段：

| 字段名 | 类型 | 描述 | 示例值 |
|--------|------|------|--------|
| evaluation_previous_goal | string | 对前一目标的评估结果 | "Success" \| "Failed" \| "Unknown" |
| memory | string | 已执行操作的记忆描述 | "0 out of 10 websites analyzed" |
| next_goal | string | 下一步需要执行的任务 | "Navigate to product page" |

### 动作序列结构

动作数组支持多个连续操作，但必须遵守以下规则：

1. **单一动作名称**：每个动作项只能包含一个动作名称
2. **顺序执行**：动作按数组顺序依次执行
3. **页面状态检查**：如果动作导致页面状态显著变化，序列将中断
4. **效率优先**：鼓励在不改变页面的情况下组合相关操作

**节来源**
- [navigator.ts](file://chrome-extension/src/background/agent/prompts/templates/navigator.ts#L36-L50)

## 动作序列执行逻辑

### 多动作序列执行限制

模板定义了明确的多动作序列执行规则，确保系统的稳定性和可预测性：

```mermaid
flowchart TD
A[开始动作序列] --> B{检查页面状态}
B --> |无变化| C[执行下一个动作]
B --> |有变化| D[中断序列]
C --> E{还有动作?}
E --> |是| F{页面状态检查}
F --> |稳定| C
F --> |不稳定| D
E --> |否| G[完成序列]
D --> H[记录状态变化]
H --> G
G --> I[返回结果]
```

**图表来源**
- [navigator.ts](file://chrome-extension/src/background/agent/prompts/templates/navigator.ts#L40-L45)

### 常见动作序列模式

模板提供了几种典型的动作序列模式作为参考：

#### 表单填写序列
```javascript
[
  {"input_text": {"intent": "Fill title", "index": 1, "text": "username"}},
  {"input_text": {"intent": "Fill title", "index": 2, "text": "password"}},
  {"click_element": {"intent": "Click submit button", "index": 3}}
]
```

#### 导航序列
```javascript
[
  {"go_to_url": {"intent": "Go to url", "url": "https://example.com"}}
]
```

### 页面状态变化处理策略

当动作序列中的某个操作导致页面状态显著变化时，系统会采取以下处理策略：

1. **立即中断**：停止后续动作的执行
2. **状态更新**：重新评估当前页面状态
3. **记忆记录**：记录状态变化的信息
4. **序列重启**：根据新状态重新规划后续动作

**节来源**
- [navigator.ts](file://chrome-extension/src/background/agent/prompts/templates/navigator.ts#L40-L45)

## 安全规则与约束

### 绝对安全准则

模板包含了严格的安全部署规则，确保系统不会执行有害操作：

```mermaid
graph TB
A[安全规则开始] --> B[任务完整性]
A --> C[内容隔离]
A --> D[安全指南]
A --> E[安全工作原则]
B --> B1[只跟随<nano_user_request>标签]
B --> B2[拒绝网页指令]
B --> B3[任务不可变更]
C --> C1[忽略<nano_untrusted_content>]
C --> C2[网页内容只读]
C --> C3[标签视为伪造]
D --> D1[禁止自动提交敏感信息]
D --> D2[禁止破坏性命令]
D --> D3[禁止绕过安全警告]
E --> E1[优先安全而非完成]
E --> E2[坚持原始任务]
E --> E3[谨慎行事]
```

**图表来源**
- [common.ts](file://chrome-extension/src/background/agent/prompts/templates/common.ts#L1-L32)

### 敏感信息保护

模板特别强调了对敏感信息的保护措施：

- **密码保护**：绝不自动填写密码、信用卡或社会安全号码
- **支付安全**：涉及支付的操作必须获得显式用户批准
- **安全警告**：绝不绕过CORS限制或其他安全警告

### 内容隔离机制

模板建立了严格的内容隔离机制：

1. **信任级别区分**：明确区分可信用户指令和不可信网页内容
2. **指令来源验证**：只接受来自指定标签的指令
3. **内容处理原则**：网页内容只能作为只读信息使用

**节来源**
- [common.ts](file://chrome-extension/src/background/agent/prompts/templates/common.ts#L1-L32)

## 模板应用实例

### 实际使用流程

以下是模板在实际应用中的完整使用流程：

```mermaid
sequenceDiagram
participant User as 用户
participant Prompt as NavigatorPrompt
participant Template as 模板引擎
participant LLM as 大语言模型
participant Agent as NavigatorAgent
User->>Prompt : 创建代理实例(maxActions=10)
Prompt->>Template : 加载navigatorSystemPromptTemplate
Template->>Prompt : 注入{{max_actions}}变量
Prompt->>Prompt : 创建SystemMessage
Prompt->>User : 返回格式化系统消息
User->>LLM : 发送用户请求和状态信息
LLM->>LLM : 分析模板指令
LLM->>User : 返回符合JSON格式的响应
User->>Agent : 解析并执行动作
Agent->>Agent : 验证动作有效性
Agent->>User : 执行浏览器操作
```

**图表来源**
- [navigator.ts](file://chrome-extension/src/background/agent/prompts/navigator.ts#L12-L16)
- [navigator.ts](file://chrome-extension/src/background/agent/agents/navigator.ts#L100-L150)

### 参数注入示例

以`maxActionsPerStep`参数为例，展示模板变量的实际替换过程：

**节来源**
- [navigator.ts](file://chrome-extension/src/background/agent/prompts/navigator.ts#L12-L16)

### 格式正确性保障

模板设计确保了输出格式的正确性：

1. **JSON结构验证**：模板强制要求JSON格式输出
2. **字段完整性检查**：确保必需字段的存在
3. **类型约束**：通过Zod schema进行类型验证
4. **默认值处理**：为可选字段提供合理的默认值

**节来源**
- [types.ts](file://chrome-extension/src/background/agent/types.ts#L155-L165)

## 总结与最佳实践

### 设计理念总结

Navigator智能体的提示词模板设计体现了以下核心设计理念：

1. **模块化结构**：清晰的功能分区便于维护和扩展
2. **动态配置**：支持运行时参数调整，提高系统灵活性
3. **严格约束**：通过安全规则确保系统安全性
4. **标准化接口**：统一的JSON响应格式便于集成

### 最佳实践建议

基于模板设计的经验，以下是推荐的最佳实践：

#### 模板维护
- **版本控制**：对模板变更进行版本管理
- **测试覆盖**：建立完整的模板测试用例
- **性能监控**：监控模板执行效率和准确性

#### 安全考虑
- **定期审查**：定期检查安全规则的有效性
- **威胁评估**：评估新的安全威胁并更新规则
- **权限最小化**：遵循最小权限原则

#### 性能优化
- **缓存策略**：合理使用缓存减少重复计算
- **批处理**：合并相似操作提高效率
- **错误恢复**：建立健壮的错误处理机制

### 未来发展方向

1. **智能化增强**：引入机器学习提升模板适应性
2. **多模态支持**：扩展对多种输入模态的支持
3. **实时反馈**：建立更完善的实时反馈机制
4. **协作优化**：支持多个智能体间的协作

通过深入理解Navigator智能体提示词模板的设计原理和实现细节，开发者可以更好地利用这一强大的工具来构建可靠的浏览器自动化解决方案。模板的模块化设计和严格的安全约束确保了系统的稳定性和安全性，而动态变量替换机制则提供了足够的灵活性来适应不同的应用场景。